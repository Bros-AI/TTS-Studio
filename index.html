<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini TTS Studio Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #06060a;
            --bg-secondary: #0d0d14;
            --bg-tertiary: #14141f;
            --bg-card: #0f0f18;
            --bg-elevated: #1a1a28;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --accent-tertiary: #a5b4fc;
            --accent-glow: rgba(99, 102, 241, 0.35);
            --accent-pink: #ec4899;
            --accent-cyan: #22d3ee;
            --accent-emerald: #10b981;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #1e293b;
            --border-light: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gradient-main: linear-gradient(135deg, #6366f1 0%, #ec4899 50%, #22d3ee 100%);
            --gradient-card: linear-gradient(180deg, rgba(99, 102, 241, 0.08) 0%, transparent 60%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            background: 
                radial-gradient(ellipse 100% 80% at 10% -30%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse 80% 60% at 90% 110%, rgba(236, 72, 153, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse 60% 50% at 50% 50%, rgba(34, 211, 238, 0.05) 0%, transparent 50%);
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 480px;
            width: 90%;
            position: relative;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gradient-main);
        }

        .modal-icon {
            width: 72px;
            height: 72px;
            background: var(--gradient-main);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1.5rem;
            box-shadow: 0 8px 32px var(--accent-glow);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .modal-subtitle {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .modal-input-group {
            margin-bottom: 1.5rem;
        }

        .modal-input-group label {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .modal-input-wrapper {
            position: relative;
        }

        .modal-input-wrapper input {
            width: 100%;
            padding: 1rem 3rem 1rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .modal-input-wrapper input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .toggle-visibility {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s ease;
        }

        .toggle-visibility:hover {
            color: var(--text-primary);
        }

        .modal-link {
            display: block;
            text-align: center;
            color: var(--accent-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .modal-link:hover {
            color: var(--accent-tertiary);
        }

        .modal-btn {
            width: 100%;
            padding: 1rem;
            background: var(--gradient-main);
            border: none;
            border-radius: 12px;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--accent-glow);
        }

        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .modal-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: none;
        }

        .modal-error.show {
            display: block;
        }

        /* Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-main);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 24px var(--accent-glow);
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        .header-btn.connected {
            border-color: var(--success);
        }

        .header-btn.connected .status-indicator {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem;
        }

        @media (max-width: 1100px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-card);
            pointer-events: none;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
            position: relative;
        }

        .card-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-elevated);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .card-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-elevated);
            border-radius: 6px;
            color: var(--text-muted);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
            position: relative;
        }

        .form-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .form-label label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-label .char-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        textarea,
        select,
        input[type="text"] {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            position: relative;
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            line-height: 1.7;
        }

        textarea:focus,
        select:focus,
        input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 1.25rem;
        }

        .mode-tab {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .mode-tab:hover {
            color: var(--text-secondary);
        }

        .mode-tab.active {
            background: var(--accent-primary);
            color: white;
            box-shadow: 0 2px 8px var(--accent-glow);
        }

        /* Speaker Config */
        .speakers-container {
            display: none;
        }

        .speakers-container.show {
            display: block;
        }

        .speaker-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .speaker-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .speaker-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .speaker-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .speaker-row input,
        .speaker-row select {
            padding: 0.75rem;
            font-size: 0.8rem;
        }

        /* Voice Selection */
        .voice-select-container {
            position: relative;
        }

        .voice-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        .voice-preview-icon {
            width: 36px;
            height: 36px;
            background: var(--gradient-main);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .voice-preview-info {
            flex: 1;
        }

        .voice-preview-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .voice-preview-style {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Pricing Card */
        .pricing-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .pricing-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .pricing-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pricing-model {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-secondary);
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .pricing-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .pricing-item-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .pricing-item-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .pricing-item-value.highlight {
            color: var(--accent-emerald);
        }

        .pricing-total {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .pricing-total-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .pricing-total-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-emerald);
        }

        /* Generate Button */
        .generate-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--gradient-main);
            border: none;
            border-radius: 12px;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px var(--accent-glow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .generate-btn:hover::before {
            left: 100%;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--accent-glow);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn:disabled::before {
            display: none;
        }

        .generate-btn .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status Message */
        .status-message {
            padding: 0.875rem 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            font-size: 0.85rem;
            display: none;
            align-items: center;
            gap: 0.75rem;
        }

        .status-message.show {
            display: flex;
        }

        .status-message.loading {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--accent-primary);
            color: var(--accent-secondary);
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        /* Audio Player */
        .audio-section {
            margin-top: 1.5rem;
        }

        .audio-player {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.25rem;
            display: none;
        }

        .audio-player.show {
            display: block;
        }

        .audio-visualizer {
            height: 64px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .wave-bars {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 100%;
            padding: 0.75rem;
        }

        .wave-bar {
            width: 3px;
            background: var(--gradient-main);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .play-btn {
            width: 44px;
            height: 44px;
            background: var(--gradient-main);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .play-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .progress-wrapper {
            flex: 1;
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-main);
            width: 0%;
            transition: width 0.1s linear;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            margin-top: 0.375rem;
        }

        .time-info span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .download-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .download-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        /* Placeholder */
        .audio-placeholder {
            text-align: center;
            padding: 2.5rem 1rem;
            color: var(--text-muted);
        }

        .audio-placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .audio-placeholder p {
            font-size: 0.9rem;
        }

        /* Right Sidebar */
        .sidebar-card {
            margin-bottom: 1.5rem;
        }

        /* Generated Script Preview */
        .script-preview {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .script-preview.show {
            display: block;
        }

        .script-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .script-preview-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .script-preview-content {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* AI Config Display */
        .ai-config-display {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .ai-config-display.show {
            display: block;
        }

        .ai-config-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-pink);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .ai-config-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .ai-config-item:last-child {
            border-bottom: none;
        }

        .ai-config-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .ai-config-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 420px;
            height: 100%;
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            z-index: 999;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .settings-panel.show {
            right: 0;
        }

        .settings-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .settings-backdrop.show {
            opacity: 1;
            visibility: visible;
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .settings-close {
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .settings-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .settings-content {
            padding: 1.5rem;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }

        .settings-input-group {
            margin-bottom: 1rem;
        }

        .settings-input-group label {
            display: block;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .settings-input-group input,
        .settings-input-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }

        .settings-save-btn {
            width: 100%;
            padding: 1rem;
            background: var(--accent-primary);
            border: none;
            border-radius: 10px;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .settings-save-btn:hover {
            background: var(--accent-secondary);
        }

        /* Pricing Table in Settings */
        .pricing-table {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        .pricing-table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem;
        }

        .pricing-table-row:last-child {
            border-bottom: none;
        }

        .pricing-table-row.header {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .pricing-table-row span:first-child {
            color: var(--text-primary);
        }

        .pricing-table-row span:not(:first-child) {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .settings-panel {
                width: 100%;
                right: -100%;
            }

            .speaker-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-mesh"></div>
    <div class="noise-overlay"></div>

    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiModal">
        <div class="modal">
            <div class="modal-icon">üîë</div>
            <h2 class="modal-title">Welcome to Gemini TTS</h2>
            <p class="modal-subtitle">Enter your Google AI API key to start generating high-quality speech from text.</p>
            
            <div class="modal-error" id="modalError">Invalid API key. Please check and try again.</div>
            
            <div class="modal-input-group">
                <label>API Key</label>
                <div class="modal-input-wrapper">
                    <input type="password" id="modalApiKey" placeholder="AIza...">
                    <button class="toggle-visibility" onclick="toggleModalPassword()">üëÅÔ∏è</button>
                </div>
            </div>
            
            <a href="https://aistudio.google.com/apikey" target="_blank" class="modal-link">
                Get your free API key from Google AI Studio ‚Üí
            </a>
            
            <button class="modal-btn" id="modalSaveBtn" onclick="saveApiKeyFromModal()">
                Continue to App
            </button>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-backdrop" id="settingsBackdrop" onclick="closeSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2 class="settings-title">‚öôÔ∏è Settings</h2>
            <button class="settings-close" onclick="closeSettings()">√ó</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <h3 class="settings-section-title">API Configuration</h3>
                <div class="settings-input-group">
                    <label>Google AI API Key</label>
                    <input type="password" id="settingsApiKey" placeholder="Your API key">
                </div>
                <div class="settings-input-group">
                    <label>AI Content Generation Model</label>
                    <select id="settingsContentModel">
                        <option value="gemini-2.0-flash">Loading models...</option>
                    </select>
                    <button class="refresh-models-btn" onclick="fetchModels()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); font-size: 0.8rem; cursor: pointer;">
                        üîÑ Refresh Models
                    </button>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section-title">Pricing Reference (per 1M tokens)</h3>
                <div class="pricing-table">
                    <div class="pricing-table-row header">
                        <span>Model</span>
                        <span>Input</span>
                        <span>Output</span>
                    </div>
                    <div class="pricing-table-row">
                        <span>Flash TTS ‚úì</span>
                        <span style="color: var(--success);">FREE</span>
                        <span style="color: var(--success);">FREE</span>
                    </div>
                    <div class="pricing-table-row">
                        <span>Pro TTS</span>
                        <span>$1.00</span>
                        <span>$20.00</span>
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.75rem;">
                    üí° Flash TTS has a generous free tier. Pro TTS is paid only.
                </p>
            </div>

            <button class="settings-save-btn" onclick="saveSettings()">
                üíæ Save Settings
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üéôÔ∏è</div>
                <div class="logo-text">
                    <h1>Gemini TTS Studio</h1>
                    <span>Text-to-Speech Generator</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="apiStatusBtn" onclick="openSettings()">
                    <span class="status-indicator"></span>
                    <span id="apiStatusText">Not connected</span>
                </button>
                <button class="header-btn" onclick="openSettings()">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </header>

        <div class="main-layout">
            <!-- Main Content -->
            <div class="main-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon">‚úçÔ∏è</div>
                            <h2 class="card-title">Text Input</h2>
                        </div>
                        <span class="card-badge" id="modeBadge">Direct Text</span>
                    </div>

                    <!-- Mode Tabs -->
                    <div class="mode-tabs">
                        <button class="mode-tab active" data-mode="direct" onclick="setMode('direct')">
                            üìù Direct Text
                        </button>
                        <button class="mode-tab" data-mode="ai" onclick="setMode('ai')">
                            ü§ñ AI Generate
                        </button>
                    </div>

                    <!-- Direct Text Input -->
                    <div class="form-group" id="directTextGroup">
                        <div class="form-label">
                            <label>Enter your text</label>
                            <span class="char-count"><span id="charCount">0</span> chars</span>
                        </div>
                        <textarea id="textInput" placeholder="Type or paste your text here...

üí° Tips:
‚Ä¢ Add style: &quot;Say cheerfully: Hello!&quot;
‚Ä¢ Use emotions: &quot;Say in a whisper: ...&quot;
‚Ä¢ Multi-speaker format:
  Alice: Hello!
  Bob: Hi there!" oninput="updateCharCount()"></textarea>
                    </div>

                    <!-- AI Prompt Input -->
                    <div class="form-group" id="aiPromptGroup" style="display: none;">
                        <div class="form-label">
                            <label>Describe what you want</label>
                        </div>
                        <textarea id="aiPrompt" placeholder="Describe the content you want AI to generate...

Examples:
‚Ä¢ &quot;Write a 30-second podcast intro about AI&quot;
‚Ä¢ &quot;Create a dialogue between two scientists&quot;
‚Ä¢ &quot;Generate a professional voicemail greeting&quot;

The AI will automatically choose the best voices and generate the script for you."></textarea>
                        
                        <div style="margin-top: 0.75rem;">
                            <div class="form-label">
                                <label>AI Generation Model</label>
                            </div>
                            <select id="aiModelSelect" style="font-size: 0.8rem;">
                                <option value="gemini-2.0-flash">gemini-2.0-flash ‚úì FREE</option>
                            </select>
                        </div>
                    </div>

                    <!-- Model Selection -->
                    <div class="form-group">
                        <div class="form-label">
                            <label>TTS Model</label>
                        </div>
                        <select id="modelSelect" onchange="updatePricing()">
                            <option value="gemini-2.5-flash-preview-tts">Gemini 2.5 Flash TTS - Free Tier ‚úì</option>
                            <option value="gemini-2.5-pro-preview-tts">Gemini 2.5 Pro TTS (Paid - More Natural)</option>
                        </select>
                    </div>

                    <!-- Speaker Mode (Direct only) -->
                    <div id="speakerModeGroup">
                        <div class="mode-tabs" style="margin-bottom: 1rem;">
                            <button class="mode-tab active" data-speaker="single" onclick="setSpeakerMode('single')">
                                üë§ Single Speaker
                            </button>
                            <button class="mode-tab" data-speaker="multi" onclick="setSpeakerMode('multi')">
                                üë• Multi-Speaker
                            </button>
                        </div>

                        <!-- Single Speaker Config -->
                        <div class="form-group voice-select-container" id="singleSpeakerConfig">
                            <div class="form-label">
                                <label>Voice</label>
                            </div>
                            <select id="voiceSelect" onchange="updateVoicePreview()">
                                <optgroup label="üåü Bright / Upbeat">
                                    <option value="Zephyr">Zephyr - Bright</option>
                                    <option value="Puck">Puck - Upbeat</option>
                                    <option value="Aoede">Aoede - Breezy</option>
                                    <option value="Autonoe">Autonoe - Bright</option>
                                    <option value="Laomedeia">Laomedeia - Upbeat</option>
                                    <option value="Sadachbia">Sadachbia - Lively</option>
                                </optgroup>
                                <optgroup label="üåô Calm / Soft">
                                    <option value="Charon">Charon - Informative</option>
                                    <option value="Callirrhoe">Callirrhoe - Tranquil</option>
                                    <option value="Achernar">Achernar - Soft</option>
                                    <option value="Vindemiatrix">Vindemiatrix - Gentle</option>
                                    <option value="Sulafat">Sulafat - Warm</option>
                                </optgroup>
                                <optgroup label="üíº Clear / Firm">
                                    <option value="Kore" selected>Kore - Firm</option>
                                    <option value="Iapetus">Iapetus - Clear</option>
                                    <option value="Alnilam">Alnilam - Firm</option>
                                    <option value="Schedar">Schedar - Even</option>
                                    <option value="Pulcherrima">Pulcherrima - Forward</option>
                                </optgroup>
                                <optgroup label="üòé Smooth / Casual">
                                    <option value="Algieba">Algieba - Smooth</option>
                                    <option value="Despina">Despina - Smooth</option>
                                    <option value="Umbriel">Umbriel - Easygoing</option>
                                    <option value="Zubenelgenubi">Zubenelgenubi - Casual</option>
                                </optgroup>
                                <optgroup label="üé≠ Character">
                                    <option value="Fenrir">Fenrir - Excitable</option>
                                    <option value="Leda">Leda - Youthful</option>
                                    <option value="Orus">Orus - Firm</option>
                                    <option value="Enceladus">Enceladus - Breathy</option>
                                    <option value="Erinome">Erinome - Clear</option>
                                    <option value="Algenib">Algenib - Gravelly</option>
                                    <option value="Rasalgethi">Rasalgethi - Informative</option>
                                    <option value="Gacrux">Gacrux - Mature</option>
                                    <option value="Achird">Achird - Friendly</option>
                                    <option value="Sadaltager">Sadaltager - Knowledgeable</option>
                                </optgroup>
                            </select>
                            <div class="voice-preview" id="voicePreview">
                                <div class="voice-preview-icon">üó£Ô∏è</div>
                                <div class="voice-preview-info">
                                    <div class="voice-preview-name" id="voicePreviewName">Kore</div>
                                    <div class="voice-preview-style" id="voicePreviewStyle">Firm ‚Ä¢ Clear articulation</div>
                                </div>
                            </div>
                        </div>

                        <!-- Multi Speaker Config -->
                        <div class="speakers-container" id="multiSpeakerConfig">
                            <div class="speaker-card">
                                <div class="speaker-header">
                                    <span class="speaker-number">Speaker 1</span>
                                </div>
                                <div class="speaker-row">
                                    <input type="text" id="speaker1Name" placeholder="Name (e.g., Alice)">
                                    <select id="speaker1Voice">
                                        <option value="Kore">Kore - Firm</option>
                                        <option value="Leda">Leda - Youthful</option>
                                        <option value="Aoede">Aoede - Breezy</option>
                                        <option value="Charon">Charon - Informative</option>
                                    </select>
                                </div>
                            </div>
                            <div class="speaker-card">
                                <div class="speaker-header">
                                    <span class="speaker-number">Speaker 2</span>
                                </div>
                                <div class="speaker-row">
                                    <input type="text" id="speaker2Name" placeholder="Name (e.g., Bob)">
                                    <select id="speaker2Voice">
                                        <option value="Puck" selected>Puck - Upbeat</option>
                                        <option value="Fenrir">Fenrir - Excitable</option>
                                        <option value="Enceladus">Enceladus - Breathy</option>
                                        <option value="Gacrux">Gacrux - Mature</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Config Display (shown after AI generation) -->
                    <div class="ai-config-display" id="aiConfigDisplay">
                        <div class="ai-config-title">ü§ñ AI-Selected Configuration</div>
                        <div class="ai-config-item">
                            <span class="ai-config-label">Mode</span>
                            <span class="ai-config-value" id="aiConfigMode">-</span>
                        </div>
                        <div class="ai-config-item">
                            <span class="ai-config-label">Voice(s)</span>
                            <span class="ai-config-value" id="aiConfigVoices">-</span>
                        </div>
                        <div class="ai-config-item">
                            <span class="ai-config-label">Style</span>
                            <span class="ai-config-value" id="aiConfigStyle">-</span>
                        </div>
                    </div>

                    <!-- Script Preview -->
                    <div class="script-preview" id="scriptPreview">
                        <div class="script-preview-header">
                            <span class="script-preview-title">üìú Generated Script</span>
                        </div>
                        <div class="script-preview-content" id="scriptContent"></div>
                    </div>

                    <!-- Pricing Estimation -->
                    <div class="pricing-card">
                        <div class="pricing-header">
                            <span class="pricing-title">üí∞ Estimated Cost</span>
                            <span class="pricing-model" id="pricingModelLabel">Flash TTS</span>
                        </div>
                        <div class="pricing-grid">
                            <div class="pricing-item">
                                <div class="pricing-item-label">Input Tokens</div>
                                <div class="pricing-item-value" id="inputTokens">~0</div>
                            </div>
                            <div class="pricing-item">
                                <div class="pricing-item-label">Input Cost</div>
                                <div class="pricing-item-value" id="inputCost">$0.0000</div>
                            </div>
                            <div class="pricing-item">
                                <div class="pricing-item-label">Output Tokens (est.)</div>
                                <div class="pricing-item-value" id="outputTokens">~0</div>
                            </div>
                            <div class="pricing-item">
                                <div class="pricing-item-label">Output Cost</div>
                                <div class="pricing-item-value" id="outputCost">$0.0000</div>
                            </div>
                        </div>
                        <div class="pricing-total">
                            <span class="pricing-total-label">Estimated Total</span>
                            <span class="pricing-total-value" id="totalCost">$0.0000</span>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button class="generate-btn" id="generateBtn" onclick="generateAudio()">
                        <span id="generateBtnIcon">üéôÔ∏è</span>
                        <span id="generateBtnText">Generate Audio</span>
                    </button>

                    <!-- Status Message -->
                    <div class="status-message" id="statusMessage">
                        <span id="statusIcon"></span>
                        <span id="statusText"></span>
                    </div>

                    <!-- Audio Section -->
                    <div class="audio-section">
                        <div class="audio-player" id="audioPlayer">
                            <div class="audio-visualizer">
                                <div class="wave-bars" id="waveBars"></div>
                            </div>
                            <div class="audio-controls">
                                <button class="play-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
                                <div class="progress-wrapper">
                                    <div class="progress-bar" onclick="seekAudio(event)">
                                        <div class="progress-fill" id="progressFill"></div>
                                    </div>
                                    <div class="time-info">
                                        <span id="currentTime">0:00</span>
                                        <span id="duration">0:00</span>
                                    </div>
                                </div>
                                <button class="download-btn" onclick="downloadAudio()">
                                    ‚¨áÔ∏è Download
                                </button>
                            </div>
                        </div>
                        <div class="audio-placeholder" id="audioPlaceholder">
                            <div class="audio-placeholder-icon">üéß</div>
                            <p>Your generated audio will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="card sidebar-card">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon">üìä</div>
                            <h2 class="card-title">Quick Stats</h2>
                        </div>
                    </div>
                    <div class="pricing-grid" style="margin-bottom: 1rem;">
                        <div class="pricing-item">
                            <div class="pricing-item-label">Generations</div>
                            <div class="pricing-item-value" id="totalGenerations">0</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-item-label">Total Spent</div>
                            <div class="pricing-item-value highlight" id="totalSpent">$0.00</div>
                        </div>
                    </div>
                </div>

                <div class="card sidebar-card">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon">üó£Ô∏è</div>
                            <h2 class="card-title">Voice Guide</h2>
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.7;">
                        <p style="margin-bottom: 0.75rem;"><strong style="color: var(--text-primary);">30 voices</strong> across 5 categories:</p>
                        <p>üåü <strong>Bright/Upbeat</strong> - Energetic, positive</p>
                        <p>üåô <strong>Calm/Soft</strong> - Soothing, gentle</p>
                        <p>üíº <strong>Clear/Firm</strong> - Professional</p>
                        <p>üòé <strong>Smooth/Casual</strong> - Relaxed</p>
                        <p>üé≠ <strong>Character</strong> - Unique personalities</p>
                        <p style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            <strong style="color: var(--accent-secondary);">24 languages</strong> auto-detected
                        </p>
                    </div>
                </div>

                <div class="card sidebar-card">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon">üí°</div>
                            <h2 class="card-title">Pro Tips</h2>
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.7;">
                        <p style="margin-bottom: 0.5rem;">‚Ä¢ Use <code style="background: var(--bg-tertiary); padding: 0.125rem 0.375rem; border-radius: 4px;">Say cheerfully:</code> for style</p>
                        <p style="margin-bottom: 0.5rem;">‚Ä¢ Match voice to emotion</p>
                        <p style="margin-bottom: 0.5rem;">‚Ä¢ AI mode auto-picks voices</p>
                        <p>‚Ä¢ Flash TTS is 2x cheaper</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION
        // ============================================================================
        
        const VOICES = {
            "Zephyr": { style: "Bright", desc: "Energetic and positive" },
            "Puck": { style: "Upbeat", desc: "Cheerful and lively" },
            "Charon": { style: "Informative", desc: "Clear and educational" },
            "Kore": { style: "Firm", desc: "Clear articulation" },
            "Fenrir": { style: "Excitable", desc: "Enthusiastic energy" },
            "Leda": { style: "Youthful", desc: "Young and fresh" },
            "Orus": { style: "Firm", desc: "Confident and steady" },
            "Aoede": { style: "Breezy", desc: "Light and airy" },
            "Callirrhoe": { style: "Tranquil", desc: "Calm and peaceful" },
            "Autonoe": { style: "Bright", desc: "Cheerful tone" },
            "Enceladus": { style: "Breathy", desc: "Soft and intimate" },
            "Iapetus": { style: "Clear", desc: "Crisp pronunciation" },
            "Umbriel": { style: "Easygoing", desc: "Relaxed casual" },
            "Algieba": { style: "Smooth", desc: "Flowing delivery" },
            "Despina": { style: "Smooth", desc: "Polished sound" },
            "Erinome": { style: "Clear", desc: "Articulate speech" },
            "Algenib": { style: "Gravelly", desc: "Deep texture" },
            "Rasalgethi": { style: "Informative", desc: "Knowledgeable tone" },
            "Laomedeia": { style: "Upbeat", desc: "Positive energy" },
            "Achernar": { style: "Soft", desc: "Gentle delivery" },
            "Alnilam": { style: "Firm", desc: "Authoritative" },
            "Schedar": { style: "Even", desc: "Balanced tone" },
            "Gacrux": { style: "Mature", desc: "Adult character" },
            "Pulcherrima": { style: "Forward", desc: "Direct approach" },
            "Achird": { style: "Friendly", desc: "Warm and approachable" },
            "Zubenelgenubi": { style: "Casual", desc: "Laid-back style" },
            "Vindemiatrix": { style: "Gentle", desc: "Soft and kind" },
            "Sadachbia": { style: "Lively", desc: "Animated delivery" },
            "Sadaltager": { style: "Knowledgeable", desc: "Expert tone" },
            "Sulafat": { style: "Warm", desc: "Comforting voice" }
        };

        const PRICING = {
            "gemini-2.5-flash-preview-tts": { input: 0.50, output: 10.00, name: "Flash TTS", free: true },
            "gemini-2.5-pro-preview-tts": { input: 1.00, output: 20.00, name: "Pro TTS", free: false }
        };

        // Models with free tier (based on Google's pricing page)
        const FREE_TIER_MODELS = [
            'gemini-2.0-flash',
            'gemini-2.0-flash-lite', 
            'gemini-2.5-flash',
            'gemini-2.5-flash-lite',
            'gemini-2.5-flash-preview',
            'gemini-1.5-flash',
            'gemini-1.5-flash-8b',
            'gemini-1.0-pro',
            'gemma',
            'gemma-2',
            'gemma-3',
            'embedding'
        ];

        // Check if model has free tier
        function isFreeTierModel(modelName) {
            const name = modelName.toLowerCase();
            return FREE_TIER_MODELS.some(free => name.includes(free.toLowerCase()));
        }

        // Fetch models from API
        async function fetchModels() {
            if (!state.apiKey) {
                console.log('No API key, using default models');
                populateDefaultModels();
                return;
            }

            const select = document.getElementById('settingsContentModel');
            const aiSelect = document.getElementById('aiModelSelect');
            select.innerHTML = '<option value="">Loading...</option>';
            aiSelect.innerHTML = '<option value="">Loading...</option>';
            select.disabled = true;
            aiSelect.disabled = true;

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models?key=${state.apiKey}`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch models');
                }

                const data = await response.json();
                const models = data.models || [];

                // Filter for text generation models (exclude TTS, embedding, vision-only)
                const textModels = models.filter(m => {
                    const name = m.name.toLowerCase();
                    const supportedMethods = m.supportedGenerationMethods || [];
                    return supportedMethods.includes('generateContent') &&
                           !name.includes('tts') &&
                           !name.includes('embedding') &&
                           !name.includes('imagen') &&
                           !name.includes('veo') &&
                           !name.includes('aqa');
                });

                // Sort: free tier first, then by name
                textModels.sort((a, b) => {
                    const aFree = isFreeTierModel(a.name);
                    const bFree = isFreeTierModel(b.name);
                    if (aFree && !bFree) return -1;
                    if (!aFree && bFree) return 1;
                    return a.name.localeCompare(b.name);
                });

                // Build options HTML
                const freeModels = textModels.filter(m => isFreeTierModel(m.name));
                const paidModels = textModels.filter(m => !isFreeTierModel(m.name));

                let optionsHTML = '';
                
                if (freeModels.length > 0) {
                    optionsHTML += '<optgroup label="‚úì Free Tier">';
                    freeModels.forEach(m => {
                        const modelId = m.name.replace('models/', '');
                        optionsHTML += `<option value="${modelId}">${modelId} ‚úì FREE</option>`;
                    });
                    optionsHTML += '</optgroup>';
                }

                if (paidModels.length > 0) {
                    optionsHTML += '<optgroup label="üí∞ Paid">';
                    paidModels.forEach(m => {
                        const modelId = m.name.replace('models/', '');
                        optionsHTML += `<option value="${modelId}">${modelId}</option>`;
                    });
                    optionsHTML += '</optgroup>';
                }

                // Populate both selects
                select.innerHTML = optionsHTML;
                aiSelect.innerHTML = optionsHTML;

                // Set saved value or default to first free model
                const defaultModel = freeModels.length > 0 ? freeModels[0].name.replace('models/', '') : '';
                
                if (state.contentModel && select.querySelector(`option[value="${state.contentModel}"]`)) {
                    select.value = state.contentModel;
                    aiSelect.value = state.contentModel;
                } else if (defaultModel) {
                    select.value = defaultModel;
                    aiSelect.value = defaultModel;
                    state.contentModel = defaultModel;
                }

                // Store fetched models
                state.availableModels = textModels;

            } catch (error) {
                console.error('Error fetching models:', error);
                populateDefaultModels();
            } finally {
                select.disabled = false;
                aiSelect.disabled = false;
            }
        }

        // Fallback default models
        function populateDefaultModels() {
            const defaultHTML = `
                <optgroup label="‚úì Free Tier">
                    <option value="gemini-2.0-flash">gemini-2.0-flash ‚úì FREE</option>
                    <option value="gemini-2.5-flash">gemini-2.5-flash ‚úì FREE</option>
                    <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite ‚úì FREE</option>
                </optgroup>
                <optgroup label="üí∞ Paid">
                    <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                </optgroup>
            `;
            
            const select = document.getElementById('settingsContentModel');
            const aiSelect = document.getElementById('aiModelSelect');
            
            select.innerHTML = defaultHTML;
            aiSelect.innerHTML = defaultHTML;
            
            if (state.contentModel) {
                select.value = state.contentModel;
                aiSelect.value = state.contentModel;
            }
        }

        // ============================================================================
        // STATE
        // ============================================================================
        
        const state = {
            apiKey: localStorage.getItem('gemini_api_key') || '',
            contentModel: localStorage.getItem('gemini_content_model') || 'gemini-2.0-flash',
            mode: 'direct',
            speakerMode: 'single',
            isPlaying: false,
            audioBlob: null,
            audioUrl: null,
            totalGenerations: parseInt(localStorage.getItem('total_generations') || '0'),
            totalSpent: parseFloat(localStorage.getItem('total_spent') || '0')
        };

        let audioElement = null;
        let waveAnimationId = null;

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            // Check API key
            if (!state.apiKey) {
                showApiModal();
                populateDefaultModels();
            } else {
                updateApiStatus(true);
                fetchModels(); // Fetch models from API
            }

            // Load settings
            document.getElementById('settingsApiKey').value = state.apiKey;

            // Initialize UI
            initWaveBars();
            updateVoicePreview();
            updatePricing();
            updateStats();

            // Setup text input listener for pricing
            document.getElementById('textInput').addEventListener('input', updatePricing);
            document.getElementById('aiPrompt').addEventListener('input', updatePricing);
        }

        function initWaveBars() {
            const container = document.getElementById('waveBars');
            container.innerHTML = Array.from({ length: 50 }, () => 
                `<div class="wave-bar" style="height: 16px;"></div>`
            ).join('');
        }

        // ============================================================================
        // MODAL HANDLING
        // ============================================================================
        
        function showApiModal() {
            document.getElementById('apiModal').classList.add('show');
        }

        function hideApiModal() {
            document.getElementById('apiModal').classList.remove('show');
        }

        function toggleModalPassword() {
            const input = document.getElementById('modalApiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function saveApiKeyFromModal() {
            const apiKey = document.getElementById('modalApiKey').value.trim();
            const errorEl = document.getElementById('modalError');

            if (!apiKey) {
                errorEl.textContent = 'Please enter an API key.';
                errorEl.classList.add('show');
                return;
            }

            errorEl.classList.remove('show');

            // Save and continue (no validation fetch)
            state.apiKey = apiKey;
            localStorage.setItem('gemini_api_key', apiKey);
            document.getElementById('settingsApiKey').value = apiKey;
            updateApiStatus(true);
            hideApiModal();
            
            // Fetch models now that we have an API key
            fetchModels();
        }

        // ============================================================================
        // SETTINGS PANEL
        // ============================================================================
        
        function openSettings() {
            document.getElementById('settingsPanel').classList.add('show');
            document.getElementById('settingsBackdrop').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsPanel').classList.remove('show');
            document.getElementById('settingsBackdrop').classList.remove('show');
        }

        function saveSettings() {
            const apiKey = document.getElementById('settingsApiKey').value.trim();
            const contentModel = document.getElementById('settingsContentModel').value;
            const apiKeyChanged = apiKey !== state.apiKey;

            state.apiKey = apiKey;
            state.contentModel = contentModel;

            localStorage.setItem('gemini_api_key', apiKey);
            localStorage.setItem('gemini_content_model', contentModel);

            updateApiStatus(!!apiKey);
            closeSettings();

            if (!apiKey) {
                showApiModal();
            } else if (apiKeyChanged) {
                // Refresh models with new API key
                fetchModels();
            }
        }

        function updateApiStatus(connected) {
            const btn = document.getElementById('apiStatusBtn');
            const text = document.getElementById('apiStatusText');

            if (connected) {
                btn.classList.add('connected');
                text.textContent = 'Connected';
            } else {
                btn.classList.remove('connected');
                text.textContent = 'Not connected';
            }
        }

        // ============================================================================
        // MODE SWITCHING
        // ============================================================================
        
        function setMode(mode) {
            state.mode = mode;

            // Update tabs
            document.querySelectorAll('.mode-tab[data-mode]').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.mode === mode);
            });

            // Update badge
            document.getElementById('modeBadge').textContent = mode === 'ai' ? 'AI Generate' : 'Direct Text';

            // Toggle inputs
            document.getElementById('directTextGroup').style.display = mode === 'direct' ? 'block' : 'none';
            document.getElementById('aiPromptGroup').style.display = mode === 'ai' ? 'block' : 'none';
            document.getElementById('speakerModeGroup').style.display = mode === 'direct' ? 'block' : 'none';

            // Hide AI config when switching back to direct
            if (mode === 'direct') {
                document.getElementById('aiConfigDisplay').classList.remove('show');
                document.getElementById('scriptPreview').classList.remove('show');
            }

            updatePricing();
        }

        function setSpeakerMode(mode) {
            state.speakerMode = mode;

            document.querySelectorAll('.mode-tab[data-speaker]').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.speaker === mode);
            });

            document.getElementById('singleSpeakerConfig').style.display = mode === 'single' ? 'block' : 'none';
            document.getElementById('multiSpeakerConfig').classList.toggle('show', mode === 'multi');
        }

        // ============================================================================
        // VOICE PREVIEW
        // ============================================================================
        
        function updateVoicePreview() {
            const select = document.getElementById('voiceSelect');
            const voiceName = select.value;
            const voice = VOICES[voiceName];

            document.getElementById('voicePreviewName').textContent = voiceName;
            document.getElementById('voicePreviewStyle').textContent = `${voice.style} ‚Ä¢ ${voice.desc}`;
        }

        // ============================================================================
        // PRICING CALCULATION
        // ============================================================================
        
        function updatePricing() {
            const model = document.getElementById('modelSelect').value;
            const pricing = PRICING[model];
            const text = state.mode === 'ai' 
                ? document.getElementById('aiPrompt').value 
                : document.getElementById('textInput').value;

            // Estimate tokens (~4 chars per token)
            const inputTokens = Math.ceil(text.length / 4);
            // Output tokens estimation (audio generation ~2x input for TTS)
            const outputTokens = Math.ceil(inputTokens * 2.5);

            // Update UI
            document.getElementById('pricingModelLabel').textContent = pricing.name + (pricing.free ? ' (FREE)' : '');
            document.getElementById('inputTokens').textContent = `~${inputTokens.toLocaleString()}`;
            document.getElementById('outputTokens').textContent = `~${outputTokens.toLocaleString()}`;

            if (pricing.free) {
                // Free tier - show FREE
                document.getElementById('inputCost').textContent = 'FREE';
                document.getElementById('inputCost').classList.add('highlight');
                document.getElementById('outputCost').textContent = 'FREE';
                document.getElementById('outputCost').classList.add('highlight');
                document.getElementById('totalCost').textContent = 'FREE ‚úì';
            } else {
                // Calculate costs (per million tokens)
                const inputCost = (inputTokens / 1_000_000) * pricing.input;
                const outputCost = (outputTokens / 1_000_000) * pricing.output;
                const totalCost = inputCost + outputCost;
                
                document.getElementById('inputCost').textContent = `$${inputCost.toFixed(6)}`;
                document.getElementById('inputCost').classList.remove('highlight');
                document.getElementById('outputCost').textContent = `$${outputCost.toFixed(6)}`;
                document.getElementById('outputCost').classList.remove('highlight');
                document.getElementById('totalCost').textContent = `$${totalCost.toFixed(6)}`;
            }
        }

        function updateCharCount() {
            const text = document.getElementById('textInput').value;
            document.getElementById('charCount').textContent = text.length.toLocaleString();
            updatePricing();
        }

        function updateStats() {
            document.getElementById('totalGenerations').textContent = state.totalGenerations;
            document.getElementById('totalSpent').textContent = `$${state.totalSpent.toFixed(4)}`;
        }

        function addToStats(cost, isFree) {
            state.totalGenerations++;
            if (!isFree && cost > 0) {
                state.totalSpent += cost;
            }
            localStorage.setItem('total_generations', state.totalGenerations.toString());
            localStorage.setItem('total_spent', state.totalSpent.toString());
            updateStats();
        }

        // ============================================================================
        // AUDIO GENERATION
        // ============================================================================
        
        async function generateAudio() {
            if (!state.apiKey) {
                showApiModal();
                return;
            }

            const text = state.mode === 'ai' 
                ? document.getElementById('aiPrompt').value 
                : document.getElementById('textInput').value;

            if (!text.trim()) {
                showStatus('error', 'Please enter some text');
                return;
            }

            setGenerating(true);

            try {
                let contentToSpeak = text;
                let speakerConfig = null;

                if (state.mode === 'ai') {
                    // Generate script with AI including voice selection
                    showStatus('loading', 'AI is generating script and selecting voices...');
                    const aiResult = await generateWithAI(text);
                    contentToSpeak = aiResult.script;
                    speakerConfig = aiResult.config;

                    // Display AI config
                    displayAIConfig(aiResult.config);
                    displayScript(aiResult.script);
                }

                showStatus('loading', 'Converting to speech...');

                // Generate TTS
                const model = document.getElementById('modelSelect').value;
                const audioData = await generateTTS(model, contentToSpeak, speakerConfig);

                // Display audio
                displayAudio(audioData);
                showStatus('success', 'Audio generated successfully!');

                // Update stats
                const model = document.getElementById('modelSelect').value;
                const isFree = PRICING[model].free;
                const totalCostText = document.getElementById('totalCost').textContent;
                const totalCost = isFree ? 0 : parseFloat(totalCostText.replace('$', '')) || 0;
                addToStats(totalCost, isFree);

                setTimeout(() => hideStatus(), 3000);

            } catch (error) {
                console.error('Generation error:', error);
                showStatus('error', `Error: ${error.message}`);
            } finally {
                setGenerating(false);
            }
        }

        async function generateWithAI(prompt) {
            const voiceList = Object.entries(VOICES).map(([name, info]) => 
                `${name} (${info.style}: ${info.desc})`
            ).join(', ');

            const systemPrompt = `You are a TTS script generator. Based on the user's request, generate:
1. A script to be spoken
2. Voice configuration

Available voices: ${voiceList}

IMPORTANT: Respond ONLY with valid JSON in this exact format:
{
  "script": "The text to be spoken...",
  "config": {
    "mode": "single" or "multi",
    "style_instruction": "cheerfully/softly/dramatically/etc.",
    "speakers": [
      {"name": "SpeakerName", "voice": "VoiceName"}
    ]
  }
}

For single speaker, use one speaker in the array.
For multi-speaker (max 2), format script as:
SpeakerName1: dialogue
SpeakerName2: dialogue

Choose voices that match the content's tone and emotion.`;

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${state.contentModel}:generateContent?key=${state.apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: {
                            temperature: 0.7,
                            responseMimeType: "application/json"
                        }
                    })
                }
            );

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'AI generation failed');
            }

            const data = await response.json();
            const resultText = data.candidates[0].content.parts[0].text;
            
            // Parse JSON response
            const result = JSON.parse(resultText);
            return result;
        }

        async function generateTTS(model, text, aiConfig = null) {
            let requestBody;

            if (aiConfig && aiConfig.mode === 'multi' && aiConfig.speakers.length > 1) {
                // Multi-speaker from AI config
                requestBody = {
                    contents: [{ parts: [{ text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            multiSpeakerVoiceConfig: {
                                speakerVoiceConfigs: aiConfig.speakers.slice(0, 2).map(s => ({
                                    speaker: s.name,
                                    voiceConfig: {
                                        prebuiltVoiceConfig: { voiceName: s.voice }
                                    }
                                }))
                            }
                        }
                    }
                };
            } else if (aiConfig) {
                // Single speaker from AI config
                const voice = aiConfig.speakers[0]?.voice || 'Kore';
                requestBody = {
                    contents: [{ parts: [{ text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: voice }
                            }
                        }
                    }
                };
            } else if (state.speakerMode === 'multi') {
                // Multi-speaker from manual config
                const speaker1Name = document.getElementById('speaker1Name').value || 'Speaker1';
                const speaker1Voice = document.getElementById('speaker1Voice').value;
                const speaker2Name = document.getElementById('speaker2Name').value || 'Speaker2';
                const speaker2Voice = document.getElementById('speaker2Voice').value;

                requestBody = {
                    contents: [{ parts: [{ text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            multiSpeakerVoiceConfig: {
                                speakerVoiceConfigs: [
                                    {
                                        speaker: speaker1Name,
                                        voiceConfig: {
                                            prebuiltVoiceConfig: { voiceName: speaker1Voice }
                                        }
                                    },
                                    {
                                        speaker: speaker2Name,
                                        voiceConfig: {
                                            prebuiltVoiceConfig: { voiceName: speaker2Voice }
                                        }
                                    }
                                ]
                            }
                        }
                    }
                };
            } else {
                // Single speaker from manual config
                const voice = document.getElementById('voiceSelect').value;
                requestBody = {
                    contents: [{ parts: [{ text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: voice }
                            }
                        }
                    }
                };
            }

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${state.apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                }
            );

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'TTS generation failed');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].inlineData.data;
        }

        function displayAIConfig(config) {
            const display = document.getElementById('aiConfigDisplay');
            display.classList.add('show');

            document.getElementById('aiConfigMode').textContent = 
                config.mode === 'multi' ? 'Multi-Speaker' : 'Single Speaker';
            
            document.getElementById('aiConfigVoices').textContent = 
                config.speakers.map(s => `${s.name}: ${s.voice}`).join(', ');
            
            document.getElementById('aiConfigStyle').textContent = 
                config.style_instruction || 'Natural';
        }

        function displayScript(script) {
            const preview = document.getElementById('scriptPreview');
            preview.classList.add('show');
            document.getElementById('scriptContent').textContent = script;
        }

        // ============================================================================
        // AUDIO PLAYBACK
        // ============================================================================
        
        function displayAudio(base64Audio) {
            // Convert base64 to WAV blob
            const binaryString = atob(base64Audio);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            const wavBlob = createWavBlob(bytes, 24000, 1, 16);
            state.audioBlob = wavBlob;
            state.audioUrl = URL.createObjectURL(wavBlob);

            // Setup audio element
            if (audioElement) {
                audioElement.pause();
                URL.revokeObjectURL(audioElement.src);
            }

            audioElement = new Audio(state.audioUrl);
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('ended', () => {
                state.isPlaying = false;
                document.getElementById('playBtn').textContent = '‚ñ∂';
                stopWaveAnimation();
            });
            audioElement.addEventListener('loadedmetadata', () => {
                document.getElementById('duration').textContent = formatTime(audioElement.duration);
            });

            // Show player
            document.getElementById('audioPlayer').classList.add('show');
            document.getElementById('audioPlaceholder').style.display = 'none';
        }

        function createWavBlob(pcmData, sampleRate, numChannels, bitsPerSample) {
            const dataLength = pcmData.length;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bitsPerSample / 8, true);
            view.setUint16(32, numChannels * bitsPerSample / 8, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(36, 'data');
            view.setUint32(40, dataLength, true);

            const output = new Uint8Array(buffer, 44);
            output.set(pcmData);

            return new Blob([buffer], { type: 'audio/wav' });
        }

        function togglePlay() {
            if (!audioElement) return;

            if (state.isPlaying) {
                audioElement.pause();
                document.getElementById('playBtn').textContent = '‚ñ∂';
                stopWaveAnimation();
            } else {
                audioElement.play();
                document.getElementById('playBtn').textContent = '‚è∏';
                startWaveAnimation();
            }
            state.isPlaying = !state.isPlaying;
        }

        function updateProgress() {
            if (!audioElement) return;
            const progress = (audioElement.currentTime / audioElement.duration) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('currentTime').textContent = formatTime(audioElement.currentTime);
        }

        function seekAudio(event) {
            if (!audioElement) return;
            const bar = event.currentTarget;
            const rect = bar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audioElement.currentTime = percent * audioElement.duration;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function startWaveAnimation() {
            const bars = document.querySelectorAll('.wave-bar');
            function animate() {
                bars.forEach(bar => {
                    const height = Math.random() * 40 + 8;
                    bar.style.height = `${height}px`;
                });
                waveAnimationId = requestAnimationFrame(animate);
            }
            animate();
        }

        function stopWaveAnimation() {
            if (waveAnimationId) {
                cancelAnimationFrame(waveAnimationId);
                waveAnimationId = null;
            }
            document.querySelectorAll('.wave-bar').forEach(bar => {
                bar.style.height = '16px';
            });
        }

        function downloadAudio() {
            if (!state.audioBlob) return;
            const link = document.createElement('a');
            link.href = state.audioUrl;
            link.download = `gemini-tts-${Date.now()}.wav`;
            link.click();
        }

        // ============================================================================
        // UI HELPERS
        // ============================================================================
        
        function setGenerating(isGenerating) {
            const btn = document.getElementById('generateBtn');
            const icon = document.getElementById('generateBtnIcon');
            const text = document.getElementById('generateBtnText');

            btn.disabled = isGenerating;

            if (isGenerating) {
                icon.innerHTML = '<div class="spinner"></div>';
                text.textContent = 'Generating...';
            } else {
                icon.textContent = 'üéôÔ∏è';
                text.textContent = 'Generate Audio';
            }
        }

        function showStatus(type, message) {
            const el = document.getElementById('statusMessage');
            const icon = document.getElementById('statusIcon');
            const text = document.getElementById('statusText');

            el.className = `status-message show ${type}`;
            icon.innerHTML = type === 'loading' ? '<div class="spinner"></div>' : 
                            type === 'success' ? '‚úÖ' : '‚ùå';
            text.textContent = message;
        }

        function hideStatus() {
            document.getElementById('statusMessage').classList.remove('show');
        }
    </script>
</body>
</html>
